# fly.toml app configuration file generated for Rails SaaS Starter Template
# Customize this file for your application requirements

app = "your-app-name"
primary_region = "ord"  # Change to your preferred region (ord, iad, lax, etc.)
console_command = "/rails/bin/rails console"

[build]

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [[http_service.checks]]
    interval = "10s"
    method = "GET"
    path = "/health"
    timeout = "5s"
    type = "http"

[env]
  RAILS_ENV = "production"
  RAILS_LOG_TO_STDOUT = "true"
  RAILS_SERVE_STATIC_FILES = "true"
  # Database will be automatically configured by Fly.io PostgreSQL addon

# PostgreSQL Database
[[services]]
  protocol = "tcp"
  internal_port = 5432
  processes = ["postgres"]

  [[services.ports]]
    port = 5432

# Redis for Sidekiq and caching
[[services]]
  protocol = "tcp"
  internal_port = 6379
  processes = ["redis"]

  [[services.ports]]
    port = 6379

# Sidekiq background job processing
[processes]
  app = "bin/rails server"
  sidekiq = "bundle exec sidekiq"
  release = "bin/rails db:prepare"

# Machine configuration
[vm]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 1024

# Volume mounts for persistent data (optional)
# [[mounts]]
#   source = "data"
#   destination = "/data"

# Deployment configuration
[deploy]
  release_command = "bin/rails db:prepare"
  
  [deploy.env]
    RAILS_ENV = "production"

# Metrics (optional - requires Fly.io metrics addon)
# [metrics]
#   port = 9090
#   path = "/metrics"

# Secrets to set via: fly secrets set KEY=value
# - SECRET_KEY_BASE
# - DATABASE_URL (auto-configured if using Fly PostgreSQL)
# - REDIS_URL (auto-configured if using Fly Redis)
# - STRIPE_SECRET_KEY
# - STRIPE_PUBLISHABLE_KEY
# - STRIPE_WEBHOOK_SECRET
# - OPENAI_API_KEY
# - ANTHROPIC_API_KEY
# - GOOGLE_CLIENT_ID
# - GOOGLE_CLIENT_SECRET
# - GITHUB_CLIENT_ID
# - GITHUB_CLIENT_SECRET
# - SLACK_CLIENT_ID
# - SLACK_CLIENT_SECRET
# - SMTP_USERNAME
# - SMTP_PASSWORD
# - FROM_EMAIL
# - APP_HOST