# RailsPlan CI GitHub Action

A GitHub Action that validates RailsPlan applications and ensures generated code conforms to standards.

## Usage

### In Your Rails App

Add this to your `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  railsplan-validation:
    uses: ./.github/workflows/railsplan-ci.yml
    with:
      ruby_version: "3.3.0"
      rails_version: "7.2.2"
      postgres_version: "16"
```

### As a Reusable Workflow

For apps using the RailsPlan template:

```yaml
name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  railsplan-validation:
    uses: mitchellfyi/railsplan/.github/workflows/railsplan-ci.yml@v1
    with:
      ruby_version: "3.3.0"
      rails_version: "7.2.2"
```

## What It Validates

### üè• Doctor Checks (`railsplan doctor --ci`)

- Ruby version compatibility
- Template structure integrity
- Module registry validation
- Environment configuration
- Database schema integrity
- RailsPlan context validation
- Uncommitted changes in `.railsplan/` directory

### üîç Verification Checks (`railsplan verify --ci`)

- Context freshness and consistency
- No undocumented diffs in generated files
- Prompt logs consistency
- Test coverage for generated code
- Module configurations validity
- No stale artifacts
- Environment consistency

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `ruby_version` | Ruby version to use | No | `3.3.0` |
| `rails_version` | Rails version to use | No | `7.2.2` |
| `postgres_version` | PostgreSQL version | No | `16` |
| `skip_verify` | Skip verify checks | No | `false` |
| `fail_fast` | Fail fast on first error | No | `true` |

## Outputs

### Artifacts

The action uploads the following artifacts on completion:

- `.railsplan/doctor_report.json` - Detailed doctor check results
- `.railsplan/verify_report.json` - Detailed verification results  
- `.railsplan/prompts.log` - AI prompt history logs
- `.railsplan/last_generated/` - Generated code tracking
- `log/railsplan.log` - General RailsPlan logs

### PR Comments

For pull requests, the action automatically posts a summary comment with:

- Doctor check results
- Verification check results
- Ruby/Rails versions used
- Overall status

## CI Failure Conditions

The action will fail CI if:

- Schema mismatch (unable to load `db/schema.rb`)
- `railsplan doctor` returns issues
- Missing test coverage for generated code
- Uncommitted changes in `.railsplan/` directory
- Context is stale or corrupted
- Generated files have undocumented diffs

## Environment Requirements

### Rails Apps Using RailsPlan

Your Rails app should have:

- `bin/railsplan` executable
- `.railsplan/context.json` (generated by `railsplan index`)
- Standard Rails structure with `db/schema.rb`

### Legacy Rails Apps

For existing Rails apps with RailsPlan added:

- `.railsplan/context.json` file present
- RailsPlan gem installed in Gemfile

### Database Setup

The action automatically sets up:

- PostgreSQL with pgvector extension
- Redis for caching/sessions
- Test database configuration

## Configuration Examples

### Minimal Configuration

```yaml
jobs:
  validate:
    uses: mitchellfyi/railsplan/.github/workflows/railsplan-ci.yml@v1
```

### Full Configuration

```yaml
jobs:
  validate:
    uses: mitchellfyi/railsplan/.github/workflows/railsplan-ci.yml@v1
    with:
      ruby_version: "3.3.0"
      rails_version: "7.2.2"
      postgres_version: "16"
      skip_verify: false
      fail_fast: true
```

### For Non-RailsPlan Apps

If you want to use this action for validation but skip RailsPlan-specific checks:

```yaml
jobs:
  validate:
    uses: mitchellfyi/railsplan/.github/workflows/railsplan-ci.yml@v1
    with:
      skip_verify: true
```

## Troubleshooting

### Common Issues

1. **"This doesn't appear to be a railsplan application"**
   - Ensure `bin/railsplan` exists or you're running in the railsplan gem repo
   - Check that `.railsplan/context.json` is present

2. **Schema loading failed**
   - Verify `db/schema.rb` is valid Rails schema
   - Check database permissions and connectivity

3. **Context is stale**
   - Run `railsplan index` to regenerate context
   - Commit the updated `.railsplan/context.json`

4. **Uncommitted changes in .railsplan/**
   - Commit any changes in the `.railsplan/` directory
   - These files should be version controlled

### Getting Help

- Check the uploaded artifacts for detailed reports
- Review the action logs for specific error messages
- Ensure your app follows RailsPlan conventions

## Security Considerations

- The action only reads repository content and runs validation
- No sensitive data is uploaded in artifacts
- AI prompt logs may contain code snippets but no credentials
- Database is ephemeral and destroyed after the run

## Version History

- `v1` - Initial release with doctor and verify commands
- Future versions will add enhanced validation and reporting features